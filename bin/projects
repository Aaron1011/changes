#!/usr/bin/env python

import argparse
import json
import sys

from changes.config import create_app, db
from changes.models import (
    Project, Repository, RemoteEntity
)

app = create_app()
app_context = app.app_context()
app_context.push()

parser = argparse.ArgumentParser(description='Manage projects')

subparsers = parser.add_subparsers(dest='command')

parser_add = subparsers.add_parser('add', help='add project')
parser_add.add_argument('--label', dest='label', help='project label')
parser_add.add_argument('--repo-url', metavar='url', dest='repo_url', help='repository url')
parser_add.add_argument('--slug', metavar='slug', dest='slug', help='project slug')
parser_add.add_argument('--provider', dest='provider', help='provider slug')
parser_add.add_argument('--provider-options', dest='provider_options', help='provider options (json)')

args = parser.parse_args()


if args.command == 'add':
    def abort():
        print('Aborted!')
        sys.exit(1)

    name = args.label or raw_input('Project label? ') or abort()
    default_slug = name.replace(' ', '-').lower()
    slug = args.slug or raw_input('Project slug? [%s] ' % (default_slug, )) or default_slug
    repo_url = args.repo_url or raw_input('Repository URL? ') or abort()

    provider = args.provider or raw_input('Provider? (koality|jenkins) ') or abort()
    provider_options = json.loads(args.provider_options or "{}")

    if provider == 'koality':
        provider_options.setdefault('type', 'project')
        if not provider_options.get('remote_id'):
            provider_options['remote_id'] = raw_input('Koality project ID? ') or abort()
    elif provider == 'jenkins':
        provider_options.setdefault('type', 'job')
        if not provider_options.get('remote_id'):
            provider_options['remote_id'] = raw_input('Jenkins job name? ') or abort()
    else:
        abort()

    try:
        repo = Repository.query.filter_by(url=repo_url)[0]
    except IndexError:
        repo = Repository(url=repo_url)

    project = Project(
        slug=slug,
        name=name,
        repository=repo,
    )
    entity = RemoteEntity(
        provider=provider,
        internal_id=project.id,
        **provider_options
    )
    db.session.add(project)
    db.session.add(entity)
    db.session.commit()

    print "Created new project with ID {%s}" % (
        project.id,
    )
